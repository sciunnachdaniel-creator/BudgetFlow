<!DOCTYPE html>
<html lang="it">
<head>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BudgetFlow - WebApp</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICON COMPONENTS ---
        const IconWrapper = ({ children, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Plus = ({ className }) => <IconWrapper className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></IconWrapper>;
        const Trash2 = ({ className }) => <IconWrapper className={className}><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></IconWrapper>;
        const Play = ({ className }) => <IconWrapper className={className}><polygon points="5 3 19 12 5 21 5 3"></polygon></IconWrapper>;
        const RefreshCw = ({ className }) => <IconWrapper className={className}><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></IconWrapper>;
        const GripVertical = ({ className }) => <IconWrapper className={className}><circle cx="9" cy="12" r="1"></circle><circle cx="9" cy="5" r="1"></circle><circle cx="9" cy="19" r="1"></circle><circle cx="15" cy="12" r="1"></circle><circle cx="15" cy="5" r="1"></circle><circle cx="15" cy="19" r="1"></circle></IconWrapper>;
        const Euro = ({ className }) => <IconWrapper className={className}><path d="M4 10h12"></path><path d="M4 14h9"></path><path d="M19 6a7.7 7.7 0 0 0-5.2-2A7.9 7.9 0 0 0 6 12c0 4.4 3.5 8 7.8 8 2 0 3.8-.8 5.2-2"></path></IconWrapper>;
        const PieChart = ({ className }) => <IconWrapper className={className}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></IconWrapper>;
        const ArrowDown = ({ className }) => <IconWrapper className={className}><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></IconWrapper>;
        const Settings = ({ className }) => <IconWrapper className={className}><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></IconWrapper>;
        const Save = ({ className }) => <IconWrapper className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></IconWrapper>;
        const Check = ({ className }) => <IconWrapper className={className}><polyline points="20 6 9 17 4 12"></polyline></IconWrapper>;
        const Loader2 = ({ className }) => <IconWrapper className={className}><path d="M21 12a9 9 0 1 1-6.21-10.4"></path></IconWrapper>;
        const Upload = ({ className }) => <IconWrapper className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></IconWrapper>;
        const Download = ({ className }) => <IconWrapper className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></IconWrapper>;


        // --- MAIN COMPONENT ---
        const BudgetFlow = () => {
            // --- STATE ---
            const [income, setIncome] = useState(2000);
            const [fixedExpenses, setFixedExpenses] = useState([
                { id: 1, name: 'Affitto', cost: 800, color: '#3b82f6', currentFill: 0 },
                { id: 2, name: 'Spesa Alimentare', cost: 400, color: '#10b981', currentFill: 0 },
                { id: 3, name: 'Bollette', cost: 150, color: '#f59e0b', currentFill: 0 },
            ]);
            const [variableExpenses, setVariableExpenses] = useState([
                { id: 101, name: 'Risparmi', percent: 50, color: '#8b5cf6', allocated: 0 },
                { id: 102, name: 'Svago', percent: 30, color: '#ec4899', allocated: 0 },
                { id: 103, name: 'Investimenti', percent: 20, color: '#6366f1', allocated: 0 },
            ]);

            const [isAnimating, setIsAnimating] = useState(false);
            const [simulationStep, setSimulationStep] = useState(-1);
            const [remainingBudget, setRemainingBudget] = useState(0);
            const [tempPool, setTempPool] = useState(0);

            // Drag & Drop
            const [draggedItemIndex, setDraggedItemIndex] = useState(null);

            // Inputs
            const [newFixedName, setNewFixedName] = useState('');
            const [newFixedCost, setNewFixedCost] = useState('');
            const [newFixedColor, setNewFixedColor] = useState('#64748b');

            const [newVarName, setNewVarName] = useState('');
            const [newVarPercent, setNewVarPercent] = useState('');
            const [newVarColor, setNewVarColor] = useState('#64748b');

            // Saving/Loading state
            const [isSaving, setIsSaving] = useState(false);
            const [lastSaved, setLastSaved] = useState(null);
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            const fileInputRef = useRef(null);

            // --- LOCAL STORAGE LOGIC ---
            useEffect(() => {
                const loadData = () => {
                    try {
                        const savedData = localStorage.getItem('budgetflow_preset');
                        if (savedData) {
                            const data = JSON.parse(savedData);
                            if (data.income) setIncome(data.income);
                            if (data.fixedExpenses) setFixedExpenses(data.fixedExpenses.map(e => ({...e, currentFill: 0})));
                            if (data.variableExpenses) setVariableExpenses(data.variableExpenses.map(e => ({...e, allocated: 0})));
                        }
                    } catch (e) {
                        console.error("Errore caricamento dati", e);
                    } finally {
                        setIsDataLoaded(true);
                    }
                };
                loadData();
            }, []);

            const savePreset = () => {
                setIsSaving(true);
                try {
                    const dataToSave = {
                        income,
                        fixedExpenses: fixedExpenses.map(({currentFill, ...rest}) => ({...rest, currentFill: 0})),
                        variableExpenses: variableExpenses.map(({allocated, ...rest}) => ({...rest, allocated: 0})),
                        updatedAt: new Date().toISOString()
                    };
                    localStorage.setItem('budgetflow_preset', JSON.stringify(dataToSave));
                    
                    setLastSaved(new Date());
                    setTimeout(() => setLastSaved(null), 3000);
                } catch (e) {
                    console.error("Errore salvataggio", e);
                    alert("Impossibile salvare nel browser.");
                } finally {
                    setIsSaving(false);
                }
            };

            // --- EXPORT / IMPORT LOGIC ---
            const exportData = () => {
                const dataToExport = {
                    income,
                    fixedExpenses: fixedExpenses.map(({currentFill, ...rest}) => ({...rest, currentFill: 0})),
                    variableExpenses: variableExpenses.map(({allocated, ...rest}) => ({...rest, allocated: 0})),
                    exportedAt: new Date().toISOString()
                };

                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: "application/json" });
                const href = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = href;
                link.download = `budgetflow_backup_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const triggerImport = () => {
                fileInputRef.current.click();
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        // Basic Validation
                        if (typeof importedData.income !== 'number' || !Array.isArray(importedData.fixedExpenses)) {
                            alert("Il file non sembra essere un backup valido di BudgetFlow.");
                            return;
                        }

                        // Apply Data
                        setIncome(importedData.income);
                        setFixedExpenses(importedData.fixedExpenses.map(e => ({...e, currentFill: 0})));
                        setVariableExpenses(importedData.variableExpenses.map(e => ({...e, allocated: 0})));
                        
                        resetData(); // Reset simulation state
                        alert("Dati importati con successo!");
                        
                        // Optional: Auto-save to local storage after import
                        localStorage.setItem('budgetflow_preset', JSON.stringify(importedData));

                    } catch (err) {
                        console.error(err);
                        alert("Errore durante la lettura del file. Verifica che sia un JSON valido.");
                    }
                };
                reader.readAsText(file);
                // Reset input so same file can be selected again if needed
                event.target.value = null; 
            };

            // --- ANIMATION LOGIC ---
            useEffect(() => {
                if (!isAnimating) return;

                const runAnimationStep = () => {
                    if (simulationStep >= 0 && simulationStep < fixedExpenses.length) {
                        const currentExpense = fixedExpenses[simulationStep];
                        if (currentExpense.currentFill < currentExpense.cost && tempPool > 0) {
                            const step = Math.max(1, currentExpense.cost / 30); 
                            setFixedExpenses(prev => {
                                const newExp = [...prev];
                                const actualFill = Math.min(
                                    newExp[simulationStep].currentFill + step, 
                                    newExp[simulationStep].cost, 
                                    tempPool + newExp[simulationStep].currentFill
                                );
                                newExp[simulationStep].currentFill = actualFill;
                                return newExp;
                            });
                            setTempPool(prev => Math.max(0, prev - step));
                        } else {
                            setSimulationStep(prev => prev + 1);
                        }
                    } else if (simulationStep === fixedExpenses.length) {
                        const finalRemainder = tempPool;
                        setRemainingBudget(finalRemainder);
                        setVariableExpenses(prev => prev.map(v => ({
                            ...v,
                            allocated: (finalRemainder * v.percent) / 100
                        })));
                        setSimulationStep(999); 
                        setIsAnimating(false);
                    }
                };

                const timer = setTimeout(runAnimationStep, 20);
                return () => clearTimeout(timer);

            }, [isAnimating, simulationStep, tempPool, fixedExpenses]);

            const startSimulation = () => {
                setFixedExpenses(prev => prev.map(e => ({ ...e, currentFill: 0 })));
                setVariableExpenses(prev => prev.map(v => ({ ...v, allocated: 0 })));
                setTempPool(income);
                setRemainingBudget(0);
                setSimulationStep(0);
                setIsAnimating(true);
            };

            const resetData = () => {
                setIsAnimating(false);
                setFixedExpenses(prev => prev.map(e => ({ ...e, currentFill: 0 })));
                setVariableExpenses(prev => prev.map(v => ({ ...v, allocated: 0 })));
                setSimulationStep(-1);
                setRemainingBudget(0);
            };

            // --- CRUD HANDLERS ---
            const addFixedExpense = (e) => {
                e.preventDefault();
                if (!newFixedName || !newFixedCost) return;
                setFixedExpenses([...fixedExpenses, {
                    id: Date.now(),
                    name: newFixedName,
                    cost: parseFloat(newFixedCost),
                    color: newFixedColor,
                    currentFill: 0
                }]);
                setNewFixedName('');
                setNewFixedCost('');
            };

            const removeFixedExpense = (id) => {
                setFixedExpenses(fixedExpenses.filter(e => e.id !== id));
            };

            const updateFixedCost = (id, newCost) => {
                const val = newCost === '' ? 0 : parseFloat(newCost);
                setFixedExpenses(prev => prev.map(item => 
                    item.id === id ? { ...item, cost: val } : item
                ));
                resetData();
            };

            const addVariableExpense = (e) => {
                e.preventDefault();
                if (!newVarName || !newVarPercent) return;
                setVariableExpenses([...variableExpenses, {
                    id: Date.now(),
                    name: newVarName,
                    percent: parseFloat(newVarPercent),
                    color: newVarColor,
                    allocated: 0
                }]);
                setNewVarName('');
                setNewVarPercent('');
            };

            const removeVariableExpense = (id) => {
                setVariableExpenses(variableExpenses.filter(e => e.id !== id));
            };

            const updateVariablePercent = (id, newPercent) => {
                const val = newPercent === '' ? 0 : parseFloat(newPercent);
                setVariableExpenses(prev => prev.map(item => 
                    item.id === id ? { ...item, percent: val } : item
                ));
                resetData();
            };

            // --- DRAG AND DROP ---
            const onDragStart = (e, index) => {
                setDraggedItemIndex(index);
                e.dataTransfer.effectAllowed = "move";
            };

            const onDragOver = (e, index) => {
                e.preventDefault();
                if (draggedItemIndex === null || draggedItemIndex === index) return;
                const newItems = [...fixedExpenses];
                const draggedItem = newItems[draggedItemIndex];
                newItems.splice(draggedItemIndex, 1);
                newItems.splice(index, 0, draggedItem);
                setFixedExpenses(newItems);
                setDraggedItemIndex(index);
            };

            const onDragEnd = () => {
                setDraggedItemIndex(null);
                resetData();
            };

            // --- HELPER CHART ---
            const DonutChart = ({ item, size = 100 }) => {
                const center = size / 2;
                const strokeWidth = 10;
                const radius = center - strokeWidth;
                const circumference = 2 * Math.PI * radius;
                const percentage = item.cost > 0 ? (item.currentFill / item.cost) : 0;
                const strokeDashoffset = circumference - (percentage * circumference);
                const isFull = item.currentFill >= item.cost;
                const isPartial = item.currentFill > 0 && item.currentFill < item.cost;
                
                return (
                    <div className="relative flex items-center justify-center" style={{ width: size, height: size }}>
                        <svg width={size} height={size} className="transform -rotate-90 transition-all duration-100 ease-linear">
                            <circle cx={center} cy={center} r={radius} fill="transparent" stroke="#e2e8f0" strokeWidth={strokeWidth} />
                            <circle cx={center} cy={center} r={radius} fill="transparent" stroke={item.color} strokeWidth={strokeWidth}
                                strokeDasharray={circumference} strokeDashoffset={strokeDashoffset} strokeLinecap="round"
                                className="transition-all duration-75 ease-out"
                            />
                        </svg>
                        <div className="absolute flex flex-col items-center justify-center text-xs font-bold text-slate-700">
                            <span>{Math.round(percentage * 100)}%</span>
                            {isPartial && !isFull && <span className="text-[10px] text-red-500">!</span>}
                        </div>
                    </div>
                );
            };

            if (!isDataLoaded) {
                return (
                    <div className="min-h-screen bg-slate-50 flex items-center justify-center">
                        <div className="flex flex-col items-center gap-4 text-slate-400">
                            <Loader2 className="w-8 h-8 animate-spin text-indigo-500" />
                            <p className="text-sm font-medium">Caricamento Preset Locale...</p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-slate-50 text-slate-800 font-sans p-4 md:p-8">
                    <div className="max-w-6xl mx-auto space-y-8">
                        
                        {/* Hidden File Input for Import */}
                        <input 
                            type="file" 
                            ref={fileInputRef} 
                            onChange={handleFileUpload} 
                            accept=".json" 
                            style={{ display: 'none' }} 
                        />

                        {/* HEADER */}
                        <header className="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-200 gap-4">
                            <div className="flex items-center gap-3 w-full md:w-auto">
                                <div className="p-3 bg-indigo-600 rounded-xl">
                                    <PieChart className="text-white w-6 h-6" />
                                </div>
                                <div>
                                    <h1 className="text-2xl font-bold text-slate-900">BudgetFlow</h1>
                                    <p className="text-sm text-slate-500">Simula il flusso del tuo denaro</p>
                                </div>
                            </div>

                            <div className="flex flex-wrap justify-end items-center gap-3 w-full md:w-auto">
                                {/* Action Group: Import/Export/Save */}
                                <div className="flex bg-slate-100 rounded-lg p-1 gap-1">
                                    <button
                                        onClick={triggerImport}
                                        className="p-2 text-slate-600 hover:bg-white hover:shadow-sm rounded-md transition-all"
                                        title="Importa JSON"
                                    >
                                        <Upload className="w-4 h-4" />
                                    </button>
                                    <button
                                        onClick={exportData}
                                        className="p-2 text-slate-600 hover:bg-white hover:shadow-sm rounded-md transition-all"
                                        title="Esporta JSON"
                                    >
                                        <Download className="w-4 h-4" />
                                    </button>
                                    <button
                                        onClick={savePreset}
                                        disabled={isSaving}
                                        className={`flex items-center gap-2 px-3 py-2 rounded-md font-bold text-sm transition-all ${
                                            lastSaved 
                                            ? 'bg-green-100 text-green-700' 
                                            : 'text-slate-600 hover:bg-white hover:shadow-sm'
                                        }`}
                                        title="Salva nel Browser"
                                    >
                                        {isSaving ? (
                                            <Loader2 className="w-4 h-4 animate-spin" />
                                        ) : lastSaved ? (
                                            <Check className="w-4 h-4" />
                                        ) : (
                                            <Save className="w-4 h-4" />
                                        )}
                                    </button>
                                </div>

                                <div className="h-8 w-px bg-slate-200 hidden md:block"></div>

                                <div className="text-right">
                                    <label className="block text-xs font-semibold text-slate-400 uppercase tracking-wider">Reddito Totale</label>
                                    <div className="relative">
                                        <Euro className="absolute left-0 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400" />
                                        <input 
                                            type="number" 
                                            value={income} 
                                            onChange={(e) => { setIncome(Number(e.target.value)); resetData(); }}
                                            className="pl-6 pr-2 py-1 text-xl font-bold text-indigo-600 bg-transparent border-b-2 border-indigo-100 focus:border-indigo-600 focus:outline-none w-32 text-right transition-colors"
                                        />
                                    </div>
                                </div>
                                <button 
                                    onClick={isAnimating ? resetData : startSimulation}
                                    className={`flex items-center gap-2 px-6 py-3 rounded-xl font-bold text-white transition-all shadow-lg active:scale-95 ${isAnimating ? 'bg-slate-400 hover:bg-slate-500' : 'bg-indigo-600 hover:bg-indigo-700 shadow-indigo-200'}`}
                                >
                                    {isAnimating ? <RefreshCw className="w-5 h-5 animate-spin" /> : <Play className="w-5 h-5 fill-current" />}
                                    {isAnimating ? 'Reset' : 'Avvia'}
                                </button>
                            </div>
                        </header>

                        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
                            
                            {/* LEFT COLUMN: CONFIGURATION */}
                            <div className="lg:col-span-4 space-y-6">
                                
                                {/* Fixed Expenses Input */}
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                        <ArrowDown className="w-5 h-5 text-blue-500" /> Spese Fisse
                                    </h3>
                                    <p className="text-xs text-slate-500 mb-4">Queste hanno la priorità. Vengono pagate per prime.</p>
                                    <form onSubmit={addFixedExpense} className="space-y-3">
                                        <input 
                                            type="text" 
                                            placeholder="Nome (es. Affitto)" 
                                            className="w-full p-2 border rounded-lg text-sm bg-slate-50"
                                            value={newFixedName} onChange={e => setNewFixedName(e.target.value)}
                                        />
                                        <div className="flex gap-2">
                                            <input 
                                                type="number" 
                                                placeholder="Importo" 
                                                className="flex-1 p-2 border rounded-lg text-sm bg-slate-50"
                                                value={newFixedCost} onChange={e => setNewFixedCost(e.target.value)}
                                            />
                                            <input 
                                                type="color" 
                                                className="w-10 h-full p-1 border rounded-lg bg-slate-50 cursor-pointer"
                                                value={newFixedColor} onChange={e => setNewFixedColor(e.target.value)}
                                            />
                                        </div>
                                        <button type="submit" className="w-full py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold rounded-lg text-sm flex justify-center items-center gap-2 transition-colors">
                                            <Plus className="w-4 h-4" /> Aggiungi
                                        </button>
                                    </form>
                                </div>

                                {/* Variable Expenses Input */}
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <h3 className="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                                        <PieChart className="w-5 h-5 text-purple-500" /> Spese Accessorie
                                    </h3>
                                    <p className="text-xs text-slate-500 mb-4">Percentuale della rimanenza dopo le spese fisse.</p>
                                    <form onSubmit={addVariableExpense} className="space-y-3">
                                        <input 
                                            type="text" 
                                            placeholder="Nome (es. Svago)" 
                                            className="w-full p-2 border rounded-lg text-sm bg-slate-50"
                                            value={newVarName} onChange={e => setNewVarName(e.target.value)}
                                        />
                                        <div className="flex gap-2">
                                            <input 
                                                type="number" 
                                                placeholder="Percentuale %" 
                                                max="100"
                                                className="flex-1 p-2 border rounded-lg text-sm bg-slate-50"
                                                value={newVarPercent} onChange={e => setNewVarPercent(e.target.value)}
                                            />
                                            <input 
                                                type="color" 
                                                className="w-10 h-full p-1 border rounded-lg bg-slate-50 cursor-pointer"
                                                value={newVarColor} onChange={e => setNewVarColor(e.target.value)}
                                            />
                                        </div>
                                        <button type="submit" className="w-full py-2 bg-slate-100 hover:bg-slate-200 text-slate-600 font-semibold rounded-lg text-sm flex justify-center items-center gap-2 transition-colors">
                                            <Plus className="w-4 h-4" /> Aggiungi
                                        </button>
                                    </form>

                                    <div className="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-100">
                                        <div className="flex justify-between text-sm font-medium text-yellow-800">
                                            <span>Totale Allocato:</span>
                                            <span className={variableExpenses.reduce((a,b) => a + b.percent, 0) > 100 ? "text-red-600" : ""}>
                                                {variableExpenses.reduce((a,b) => a + b.percent, 0)}%
                                            </span>
                                        </div>
                                        {variableExpenses.reduce((a,b) => a + b.percent, 0) > 100 && (
                                            <p className="text-xs text-red-500 mt-1">Attenzione: Il totale supera il 100%!</p>
                                        )}
                                    </div>
                                </div>

                            </div>

                            {/* RIGHT COLUMN: VISUALIZATION */}
                            <div className="lg:col-span-8 space-y-8">
                                
                                {/* 1. FIXED EXPENSES FLOW */}
                                <section>
                                    <h2 className="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
                                        <span className="bg-blue-100 text-blue-600 py-1 px-2 rounded text-sm">1</span> Priorità Spese Fisse
                                        <span className="text-xs font-normal text-slate-400 ml-auto hidden md:inline-block">Trascina per cambiare priorità</span>
                                    </h2>
                                    
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        {fixedExpenses.map((item, index) => (
                                            <div 
                                                key={item.id}
                                                draggable
                                                onDragStart={(e) => onDragStart(e, index)}
                                                onDragOver={(e) => onDragOver(e, index)}
                                                onDragEnd={onDragEnd}
                                                className={`
                                                    relative bg-white p-4 rounded-2xl shadow-sm border-2 transition-all cursor-move group select-none
                                                    ${draggedItemIndex === index ? 'opacity-50 border-dashed border-indigo-400' : 'border-transparent hover:border-slate-200'}
                                                    flex items-center gap-4
                                                `}
                                            >
                                                <div className="text-slate-300 group-hover:text-slate-500">
                                                    <GripVertical className="w-5 h-5" />
                                                </div>
                                                
                                                <div className="flex-shrink-0">
                                                    <DonutChart item={item} size={60} />
                                                </div>

                                                <div className="flex-1 min-w-0">
                                                    <h4 className="font-bold text-slate-800 truncate">{item.name}</h4>
                                                    <div className="flex items-baseline gap-1">
                                                        <span className="text-sm font-medium text-slate-500">Target:</span>
                                                        <div className="relative group/input">
                                                            <span className="absolute left-0 top-1/2 -translate-y-1/2 text-lg font-bold pointer-events-none" style={{ color: item.color }}>€</span>
                                                            <input 
                                                                type="number"
                                                                value={item.cost}
                                                                onChange={(e) => updateFixedCost(item.id, e.target.value)}
                                                                className="w-24 pl-4 bg-transparent border-b border-transparent hover:border-slate-300 focus:border-indigo-500 focus:outline-none text-lg font-bold transition-colors"
                                                                style={{ color: item.color }}
                                                            />
                                                            <div className="absolute right-0 top-0 bottom-0 hidden group-hover/input:flex items-center pointer-events-none">
                                                                <Settings className="w-3 h-3 text-slate-300" />
                                                            </div>
                                                        </div>
                                                    </div>
                                                    {/* Progress Bar Alternative */}
                                                    <div className="w-full h-1.5 bg-slate-100 rounded-full mt-2 overflow-hidden">
                                                        <div 
                                                            className="h-full transition-all duration-200"
                                                            style={{ 
                                                                width: `${Math.min((item.currentFill / item.cost) * 100, 100)}%`,
                                                                backgroundColor: item.color
                                                            }}
                                                        />
                                                    </div>
                                                    <div className="flex justify-between text-xs mt-1 text-slate-400">
                                                        <span>Pagato: €{Math.round(item.currentFill)}</span>
                                                    </div>
                                                </div>

                                                <button 
                                                    onClick={() => removeFixedExpense(item.id)}
                                                    className="opacity-0 group-hover:opacity-100 p-2 text-slate-300 hover:text-red-500 transition-opacity"
                                                >
                                                    <Trash2 className="w-4 h-4" />
                                                </button>
                                            </div>
                                        ))}

                                        {fixedExpenses.length === 0 && (
                                            <div className="col-span-full p-8 text-center border-2 border-dashed border-slate-200 rounded-2xl text-slate-400">
                                                Nessuna spesa fissa impostata
                                            </div>
                                        )}
                                    </div>
                                </section>

                                {/* 2. REMINDER & VARIABLE */}
                                <section className="relative">
                                    {/* Connector Line */}
                                    <div className="absolute left-8 -top-8 bottom-0 w-0.5 border-l-2 border-dashed border-slate-200 -z-10 hidden lg:block"></div>

                                    <div className="flex items-center gap-4 mb-4">
                                        <h2 className="text-xl font-bold text-slate-700 flex items-center gap-2">
                                            <span className="bg-purple-100 text-purple-600 py-1 px-2 rounded text-sm">2</span> Rimanenza e Accessori
                                        </h2>
                                        {simulationStep === 999 && (
                                            <span className="ml-auto text-2xl font-bold text-indigo-600 bg-indigo-50 px-4 py-1 rounded-lg">
                                                Rimanenza: €{Math.round(remainingBudget)}
                                            </span>
                                        )}
                                    </div>

                                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                        <table className="w-full text-left">
                                            <thead className="bg-slate-50 text-slate-500 text-xs uppercase font-semibold">
                                                <tr>
                                                    <th className="p-4 pl-6">Categoria</th>
                                                    <th className="p-4 text-center">% Allocata</th>
                                                    <th className="p-4 text-right">Importo Reale</th>
                                                    <th className="p-4 w-10"></th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {variableExpenses.map(item => (
                                                    <tr key={item.id} className="group hover:bg-slate-50 transition-colors">
                                                        <td className="p-4 pl-6">
                                                            <div className="flex items-center gap-3">
                                                                <div className="w-3 h-3 rounded-full" style={{ backgroundColor: item.color }}></div>
                                                                <span className="font-medium text-slate-700">{item.name}</span>
                                                            </div>
                                                        </td>
                                                        <td className="p-4 text-center">
                                                            <div className="inline-flex items-center bg-slate-100 rounded px-2 py-1 group/edit">
                                                                <input
                                                                    type="number"
                                                                    value={item.percent}
                                                                    onChange={(e) => updateVariablePercent(item.id, e.target.value)}
                                                                    className="w-12 text-center bg-transparent text-xs font-bold text-slate-600 focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded"
                                                                />
                                                                <span className="text-xs font-bold text-slate-600 ml-1">%</span>
                                                            </div>
                                                        </td>
                                                        <td className="p-4 text-right">
                                                            <span className="font-bold text-lg text-slate-800">
                                                                €{item.allocated.toFixed(2)}
                                                            </span>
                                                        </td>
                                                        <td className="p-4 text-right">
                                                            <button 
                                                                onClick={() => removeVariableExpense(item.id)}
                                                                className="opacity-0 group-hover:opacity-100 text-slate-300 hover:text-red-500 transition-opacity"
                                                            >
                                                                <Trash2 className="w-4 h-4" />
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {variableExpenses.length === 0 && (
                                                    <tr>
                                                        <td colSpan="4" className="p-6 text-center text-slate-400 text-sm">
                                                            Nessuna spesa accessoria definita
                                                        </td>
                                                    </tr>
                                                )}
                                            </tbody>
                                            <tfoot className="bg-slate-50">
                                                <tr>
                                                    <td className="p-4 pl-6 font-semibold text-slate-600">Non Allocato (Buffer)</td>
                                                    <td className="p-4 text-center text-slate-400">-</td>
                                                    <td className="p-4 text-right font-bold text-slate-400">
                                                        €{Math.max(0, remainingBudget - variableExpenses.reduce((acc, curr) => acc + curr.allocated, 0)).toFixed(2)}
                                                    </td>
                                                    <td></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </section>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<BudgetFlow />);
    </script>
</body>
</html>
